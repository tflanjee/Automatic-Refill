#@Tom do we need to put the scaling flush in here too?

#Initialising Variables
TimeSinceRefill=0

USER INPUTS BagCapacity #Should be about 10
USER INPUTS WaterBeforeRefill #Should be about 5000
USER INPUTS FlowRatio


Void(Loop){


TimeSinceRefill=Time-TimeLastRefill #Time should be in minutes
FlowMeter=Read Flow Meter (1 for water flowing, 0 if water is off) 

While WaterThrough<WaterBeforeRefill {

WaterThrough=FlowMeter*TimeInterval #Time Interval between this reading and last reading
If FlowMeter>1{
	FlowSwitch=1
Else FlowSwitch=0
}

If (FlowSwitch=0) {
	If Repeat=0{ #This repeat value ensures that the device is just refilled once, rather than repeatedly.
	Function REFILL
}
}
ELSEIF (Flow Switch =1){
Repeat=0 #This resets the repeat value so that when the flow is no longer on, it starts to refill again
}

}
}
#The refill process is currently triggered by the mainline water being off. We also want to trigger it when the bag is completely empty.
#The other code runs until the bag is empty. When the bag is empty, the water that's been through the doser is the amount of water
#that can be purified before refill. Therefore we come outside of that while loop to this code.

Function REFILL


} #End of Void(loop)


#This function below is the actual refill process. 0 means a valve is closed or a pump is off, 1 means a valve is open or a pump is on.

Function REFILL
  PressureLine=0
  ChlorineLine=0
  WaterAirRelease=1
  ChlorineRefill=1
  Pump=1
  
  BagRefill=BagCapacity-(FlowMeter*TimeSinceRefill*FlowRatio)
  X = BagRefill/SmallPumpRate #This determines how long the minipump should be on for to refill the whole bag. Note this is variable depending on how between refills. 
  After X minutes
  ChlorineAirRelease=1
  Wait 5 seconds
  ChlorineAirRelease=0
  
  Chlorine Refill=0
  WaterAirRelease=0
  ChlorineLine=1
  PressureLine=0
  Pump=0
  
  Repeat=1
  TimeLastRefill=Time
  WaterThrough=0 #Resets the amount of water that has been through the doser since the last refill
}

